-------------------------------------------------------------------------
-- Building a binary disk image for ppc or i386 mac, and fink tarball ---
-------------------------------------------------------------------------

## Step 1. Download the most recent stable version of Macaulay2 ##
# from subversion.

 # automatically get the most recent stable version:
 STABLE=`svn list svn://u123.math.uiuc.edu/Macaulay2/stable | tail -1`

 TOPDIR=`/bin/pwd`
 mkdir M2-build
 cd M2-build
 svn co svn://u123.math.uiuc.edu/Macaulay2/stable/$STABLE M2
 mkdir installed
 mkdir build

## Step 1A. Create the source tarball for use with fink.
 # starting in M2-build
 VERSION=0.9.20
 mv M2 Macaulay2-$VERSION
 tar zcf Macaulay2-$VERSION-src.tar.gz Macaulay2-$VERSION/
 mv Macaulay2-$VERSION M2
 scp Macaulay2-$VERSION-src.tar.gz ssh.math.uiuc.edu:~  

## Step 2. Build Macaulay2 ##
## We assume libraries and include files are installed at /capybara/include and /caypbara/lib
# this one works nicely, using only standard dynamic libraries (under 10.4)

 cd M2
 make
 cd ../build
# on my ppc, which has mixed fink and capybara do
 ../M2/configure \
	--prefix=$TOPDIR/M2-build/installed \
	CPPFLAGS="-I/capybara/include -I/sw/include"\
	LDFLAGS="-L/capybara/lib -L/sw/lib"\
	LOADLIBES="-lgcc_s.10.5 -lncurses" \
	--with-veclib \
	--enable-altivec \
	--with-gdbmlib=/sw/lib/libgdbm.a \
	--with-readlinelib=/sw/lib/libreadline.a \
	--with-historylib=/sw/lib/libhistory.a \
	--with-gclib=/capybara/lib/libgc.a \
	--with-gmplib=/capybara/lib/libgmp.a

# or on i386, using just capybara
 ../M2/configure \
	--prefix=$TOPDIR/M2-build/installed \
	CPPFLAGS="-I/capybara/include"\
	LDFLAGS="-L/capybara/lib"\
	LOADLIBES="-lgcc_s.10.5 -lncurses" \
	--with-veclib \
	--enable-altivec \
	--with-gdbmlib=/capybara/lib/libgdbm.a \
	--with-readlinelib=/capybara/lib/libreadline.a \
	--with-historylib=/capybara/lib/libhistory.a \
	--with-gclib=/capybara/lib/libgc.a \
	--with-gmplib=/capybara/lib/libgmp.a

 make

 # this can take a while (started: 9:33 pm, done at 10:10pm, MBP 2 GZ) :
 make install 

## Step 3-i386.  Create the disk image

 cd ../installed
 VERSION=`grep AC_INIT ../M2/configure.ac | awk -F, '{print $2}'`
 VERSION=0.9.20
 cp ~/M2/arch/MacOSX/ReadMe-MacOSX.rtf .
 cp ~/M2/arch/MacOSX/ReadMe-MacOSX.rtf Macaulay2-$VERSION/
 rm Macaulay2-$VERSION/encapinfo
 rm Macaulay2-$VERSION/postinstall
 rm Macaulay2-$VERSION/preremove
 rm Macaulay2-$VERSION/bin/M2-emacs
 rm Macaulay2-$VERSION/bin/M2-load-libs
 rm Macaulay2-$VERSION/bin/M2-help
 cd .. # to original directory
 hdiutil create -srcfolder installed -volname Macaulay2-$VERSION-`uname -m` Macaulay2-$VERSION-macosx-`uname -m`.dmg
 scp Macaulay2-$VERSION-macosx-`uname -m`.dmg ssh.math.uiuc.edu:~


## Step 3-PPC.  Create the disk image

 cd ../installed
# VERSION=`grep AC_INIT ../M2/configure.ac | awk -F, '{print $2}'`
 VERSION=0.9.20
 cp ~/M2/arch/MacOSX/ReadMe-MacOSX.rtf .
 cp ~/M2/arch/MacOSX/ReadMe-MacOSX.rtf Macaulay2-$VERSION/
 cp ~/M2/arch/MacOSX/setup Macaulay2-$VERSION/
 rm Macaulay2-$VERSION/bin/M2-emacs
 rm Macaulay2-$VERSION/bin/M2-load-libs
 rm Macaulay2-$VERSION/bin/M2-help
 mv Macaulay2-$VERSION Macaulay2
 cd .. # to original directory
 hdiutil create -srcfolder installed -volname Macaulay2-$VERSION-ppc Macaulay2-$VERSION-macosx-ppc.dmg
 scp Macaulay2-$VERSION-macosx-ppc.dmg ssh.math.uiuc.edu:~
