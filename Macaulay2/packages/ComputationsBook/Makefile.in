TOPDIR = ../../..
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

CHAPTERS = completeIntersections \
	   constructions \
	   d-modules \
	   exterior-algebra \
	   geometry \
	   monomialIdeals \
	   preface \
	   programming \
	   schemes \
	   solving \
	   toricHilbertScheme \
	   varieties

Makefile : Makefile.in
	cd $(TOPDIR); config.status Macaulay2/packages/ComputationsBook/Makefile

tests: $(CHAPTERS:=.test)
%.test :
	$(MAKE) -C $* -f ../Makefile TOPDIR=../$(TOPDIR) run-1-test

run-1-test: test.out.expected.trim test.out.trim
	diff -u $^

test.out.trim : test.out patterns ../patterns
	sed -f ../patterns -f patterns <$< >$@

test.out.expected.trim : test.out.expected patterns ../patterns
	sed -f ../patterns -f patterns <$< >$@

changes:
	for i in $(CHAPTERS); \
	do diff -u $$i/chapter.m2 $$i/test.m2 ;\
	   diff -u $$i/chapter.out.expected $$i/test.out.expected ;\
	done

clean::
	rm -f */*.trim

test.out : test.m2 \
		../../../bin/M2 ../../../libexec/Macaulay2 \
		../../../cache/Macaulay2-doc ../../../cache/Macaulay2-made
	ulimit -v 160000 && \
	time nice -19 ../../../bin/M2 -x -s -q <test.m2 >test.out.tmp && \
	mv test.out.tmp test.out

clean::
	rm -f */*.out programming/foo

