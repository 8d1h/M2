# -*- mode: Makefile -*-
# this makefile is run from a subdirectory, hence an extra ../ in the paths
VPATH = $(chapter_srcdir)
include ../../../../include/config.Makefile
all:: check
check: test.out.expected.trim test.out.trim
	diff -u -b $^

ULIMIT := ulimit -v 380000; ulimit -t 3000
PATHJOIN := 'path = join({"./","$(chapter_srcdir)/"},path)'
M2CMD := time nice -18 ../../../bin/M2@EXE@ --stop -q -e $(PATHJOIN)
EXIT := -e "exit 0"
INPUT = -e 'input "$<"'

book_patterns := $(chapter_srcdir)/../patterns
chapter_patterns := $(chapter_srcdir)/patterns

test.out.trim : test.out $(book_patterns) $(chapter_patterns)
	<$< awk '{print $$0}' | sed -f $(book_patterns) -f $(chapter_patterns) >$@

test.out.expected.trim : test.out.expected $(book_patterns) $(chapter_patterns)
	<$< awk '{print $$0}' | sed -f $(book_patterns) -f $(chapter_patterns) >$@

test.out : test.m2 ../../../bin/M2@EXE@
	@ set -xe ; \
	  $(ULIMIT); $(M2CMD) $(INPUT) $(EXIT) >test.out.tmp; \
	  mv test.out.tmp test.out

distclean::clean
distclean::; rm -f Makefile

# capture output from the chapter's code with M2 version 0.9.2 as a standard of comparison:
# this requires an old binary, but we run it only once and save the output
OLDM2 = M2-0.9.2
OLDM2CMD := time nice -18 $(OLDM2) -s -q -e$(PATHJOIN)
capture: test.oldout test.oldvalues
test.oldvalues test.oldout : chapter.m2 ../capture.m2 ../Makefile.chapter
	@ set -xe ; \
	  $(ULIMIT); $(OLDM2CMD) -e'load "$(chapter_srcdir)/../capture.m2"; input "$<"; exit 0'  >test.oldout.tmp </dev/null; \
	  mv test.oldout.tmp test.oldout

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/Macaulay2/packages/ComputationsBook "
# End:
