include ../../config.Makefile
VPATH = @srcdir@
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

DOC=cache/doc
TEST=cache/tests

.PHONY : all test-D-modules doc check initialize clean distclean install

all :: initialize

Makefile : Makefile.in
	cd ../..; ./config.status Macaulay2/packages/Makefile

#############################################################################
all :: doc
doc : $(DOC) $(TEST) phase2
	$(MAKE) -C $(DOC) -f ../../@srcdir@/../m2/Makefile.egs srcdir=../../@srcdir@
phase2 : StateTable.m2 eliminate.m2
	for i in $^ ; do ../bin/M2 -q '-e phase=2' $$i '-e exit 0'; done
	touch "$@"
check:: doc
	$(MAKE) -C $(TEST) -f ../../@srcdir@/../m2/Makefile.tests srcdir=../../@srcdir@
#############################################################################
Dtests = $(wildcard D-modules/TST/*.tst.m2)
Dtestresults = $(Dtests:.m2=.okay)
check:: test-D-modules
test-D-modules : $(Dtestresults)
$(Dtestresults) : ../libexec/Macaulay2 ../cache/Macaulay2-doc ../cache/Macaulay2-made
%.okay : %.m2
	@ echo running test file $<
	../bin/M2 -q '-e path = prepend( "D-modules/", path )' '-e input "$<"' '-e exit 0'
	touch $@
#############################################################################
check ::
	$(MAKE) -C ComputationsBook $@
#############################################################################
initialize :: cache $(DOC) $(TEST)
clean :; rm -rf cache
cache $(DOC) $(TEST) :; mkdir -p $@

initialize :: $(DOC)/up.gif $(DOC)/next.gif $(DOC)/previous.gif $(DOC)/top.gif \
		$(DOC)/index.gif $(DOC)/null.gif 
$(DOC)/up.gif $(DOC)/next.gif $(DOC)/previous.gif $(DOC)/top.gif $(DOC)/index.gif $(DOC)/null.gif :
	ln -s ../../../html/$(shell basename $@) $(DOC)

install ::
	rm -rf $(datadir)/Macaulay2/packages
	$(INSTALL) -d $(datadir)/Macaulay2/packages $(datadir)/Macaulay2/packages/cache/doc
	$(INSTALL_DATA) *.m2 $(datadir)/Macaulay2/packages
	$(INSTALL_DATA) cache/doc/* $(datadir)/Macaulay2/packages/cache/doc

distclean : clean
	rm -f Makefile
