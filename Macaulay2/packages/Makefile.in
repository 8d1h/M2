TOPDIR = ../..
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

DOC=cache/doc
TEST=cache/tests

all :: initialize

all :: doc
doc :
	../bin/M2 -q '-e phase=2' StateTable.m2 '-e exit 0'
	../bin/M2 -q '-e phase=2' eliminate.m2  '-e exit 0'
	$(MAKE) -k -C $(DOC) -f ../../../m2/Makefile.egs

tests :: doc
	$(MAKE) -k -C $(TEST) -f ../../../m2/Makefile.tests

tests :: test-D-modules
test-D-modules :
	for i in D-modules/TST/*.tst.m2 ;\
	do echo running test file $$i ;\
	   ../bin/M2 -q '-e path = prepend( "D-modules/", path )' "-e input \"$$i\"" '-e exit 0' \
	   || exit 1 ;\
	done

initialize :: cache $(DOC) $(TEST)
clean :; rm -rf cache
cache $(DOC) $(TEST) :; mkdir $@

initialize :: $(DOC)/up.gif $(DOC)/next.gif $(DOC)/previous.gif $(DOC)/top.gif \
		$(DOC)/index.gif $(DOC)/null.gif 
$(DOC)/up.gif $(DOC)/next.gif $(DOC)/previous.gif $(DOC)/top.gif $(DOC)/index.gif $(DOC)/null.gif :
	ln -s ../../../html/$(shell basename $@) $(DOC)

install ::
	rm -rf $(datadir)/Macaulay2/packages
	$(INSTALL) -d $(datadir)/Macaulay2/packages $(datadir)/Macaulay2/packages/cache/doc
	$(INSTALL_DATA) *.m2 $(datadir)/Macaulay2/packages
	$(INSTALL_DATA) cache/doc/* $(datadir)/Macaulay2/packages/cache/doc

distclean : clean
	rm -f Makefile
