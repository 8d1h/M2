# @configure_input@
include ../../../include/config.Makefile
VPATH = @srcdir@
RESULTS := $(notdir $(patsubst %.m2, %.okay, $(wildcard @srcdir@/*.m2))) $(notdir $(patsubst %.m2-input, %.okay, $(wildcard @srcdir@/*.m2-input)))
all :: $(RESULTS)
$(RESULTS) : ../../bin/M2
ARGS := --silent --stop -q -e errorDepth=0
ARGS += -e 'path = prepend("@srcdir@/",path)'

# uncomment this for further debugging:
# ARGS += -e 'errorDepth = 0'

%.okay : %.m2
	@ echo testing $<
	ulimit -t 600; echo 'input "$<"' | ../../bin/M2 $(ARGS) 
	@ touch $@

clean::; rm -f *.okay core
distclean: clean; rm -f Makefile
Makefile : Makefile.in; cd ../../..; ./config.status Macaulay2/test/engine/Makefile

LDLIBS = 
.PHONY : benchmark
# factor.poly was generated with toString (x+3*y-14)^15*(x^2+y^4+z^7-x*y-13*x*z^2+12)^3
CFLAGS := -g -Wall -Wshadow -Wcast-qual -Wno-parentheses -Wno-sign-compare -Wno-unused-label
CFLAGS += -O3
CFLAGS += -fomit-frame-pointer
CXXFLAGS := $(CFLAGS)
LDFLAGS =  -g -L/capybara/lib
LDFLAGS += -Wl,-Map,mapfile

# CFLAGS += -pg
# CXXFLAGS += -pg
# LDFLAGS += -pg
# LDLIBS := -lcf-pg -lcfmem-pg -lntl-pg -lgmp-pg -lgc-pg -ldl -lm
LDLIBS := -lcf -lcfmem -lntl -lgmp -lgc -ldl -lm

benchmark gmon.out : factor factor.poly mapfile.demangled
	time ./factor < @srcdir@/factor.poly >factor.out
	cat factor.out
	fgrep -s '( (x^2-y*x-13*z^2*x+y^4+z^7+12)^3, (x+3*y-14)^15 )' factor.out >/dev/null
factor.gprof : gmon.out
	gprof -b ./factor >$@
factor.o factor-init.o : factor.h
mapfile factor : factor.o factor-init.o factor-init1.o 
	$(CXX) $(LDFLAGS) factor.o factor-init.o $(LDLIBS) factor-init1.o -o "$@"
mapfile.demangled : mapfile
	demangle <$< >$@

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/Macaulay2/test/engine"
# End:
