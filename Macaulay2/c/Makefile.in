# this makefile is readable only by the gnu make program
############################## main target
all:: scc1
TOPDIR = ../..
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)
############################################
%.c        : %.y
	$(YACC) $(YFLAGS) $^
	mv y.tab.c $*.c
	rm -f y.tab.h y.output
############################################################
.PHONY : clean all install
# YACC := yacc
YACC := bison -o y.tab.c
YFLAGS := -vdlt

ifeq "$(CC)" "cl"
LOADLIBES := ../../lib/gc.lib
scc1 : ../../lib/gc.lib
else
LOADLIBES := -lm -L${LIBDIR} -lgc
scc1 : ../../lib/libgc.a
endif

##############################
CNAMES := scc1.c readfile.c error.c dictionary.c list.c cprint.c \
	  type.c chk.c compat.c
HFILES := $(CNAMES:.c=.h) scc.h grammar.h
OFILES := $(CNAMES:.c=.o) grammar.o
SRCFILES := $(HFILES) $(CNAMES) grammar.y
OTHERS := makefile.dos scc.template Makefile COPYRIGHT
ALLFILES := $(SRCFILES) $(OTHERS) grammar.c
OPTIMIZE := -Winline -finline-functions -O2
INCLUDES := -I${INCDIR}
GCFLAGS  := $(INCLUDES)

ifeq "$(CC)" "cl"
  GCFLAGS += -Zi -Za
  WARNINGS := -W3
else
  GCFLAGS += -g
  WARNINGS := -Wall -Wshadow -Wcast-qual -Wtraditional -ansi
endif

CFLAGS   := $(GCFLAGS) $(WARNINGS)
############################## compiling
scc1 : $(OFILES)
	$(LINK.o) $^ $(LOADLIBES) $(LDLIBS) $(OUTPUT_OPTION)
$(OFILES) : $(HFILES)
grammar.o : grammar.c;	 	$(CC) $(GCFLAGS) -c $< $(OUTPUT_OPTION)
############################## installation 
#scc : scc.template Makefile
#	rm -f $@
#	sed -e s@--LIBDIR--@.@g \
#	    -e s@--SCC1--@../c/scc1@g \
#	    -e s@--MMGR--@.@g \
#	    <$< >$@
#	chmod a+x $@
############################## miscellaneous
allfiles: Makefile;		echo $(ALLFILES) |tr ' ' \\012 >allfiles
TAGS: $(SRCFILES);		etags $(SRCFILES)
prn :;				enscript -2r $(SRCFILES)
wc:;				wc -l $(ALLFILES)
############################## cleaning
# we purposely don't delete grammar.c so it can be used for porting
clean :
	rm -f *.o scc1 scc.a grammar.output grammar.tab.h \
		allfiles scc.install TAGS scc core y.tab.h y.output
