############################### targets to use
all ::
justM2 ::
tests ::
install ::
doc::
distclean::
################################# prologue
justM2 all :: initialize config

TOPDIR = ..
include $(TOPDIR)/config.Makefile
srcdir = @srcdir@
top_srcdir = @top_srcdir@
VPATH = $(srcdir)
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)

.PHONY: default tests all clean dirs misc config \
		initialize doc html book exe zip
ROOT := $(shell basename `pwd`)
clean::; rm -f core
################################# bin
libexec bin :; mkdir $@
clean ::; rm -rf bin
initialize :: bin libexec
################################# install
install ::
	$(INSTALL) -d $(libexecdir) $(bindir)
	$(INSTALL_PROGRAM) libexec/Macaulay2 $(DUMPDATAFILE) $(libexecdir)
	rm -f $(bindir)/M2
	<bin/M2 >$(bindir)/M2 sed \
		-e 's@^M2HOME=.*@M2HOME=$(datadir)/Macaulay2@' \
		-e 's@^EXE=.*@EXE=$(libexecdir)/Macaulay2@' \
		-e 's@^DATA=.*@DATA=$$EXE-` uname -m | sed s=/=-=g `-data@' \
		-e 's@^SETUP=.*@SETUP=$(prefix)/share/Macaulay2/m2/setup.m2@'
	chmod 0755 $(bindir)/M2
	$(INSTALL_DATA) encapinfo $(prefix)
install ::
	$(INSTALL) -d $(datadir)/Macaulay2/cache
	$(INSTALL_DATA) cache/Macaulay2-doc $(datadir)/Macaulay2/cache/Macaulay2-doc
install ::; $(MAKE) -C packages $@
install ::; $(MAKE) -C m2 $@
################################# cache
initialize :: cache
cache :; mkdir $@
distclean clean ::; rm -rf cache
################################# lib
ifeq "$(SHARED)" "yes"
justM2 all :: lib
lib :; mkdir $@
endif
distclean clean ::; rm -rf lib
################################# tmp
distclean clean ::; rm -rf tmp
################################# util
initialize ::; $(MAKE) -C util all
clean ::; $(MAKE) NODEPENDS=1 -C util clean
wc ::; $(MAKE) NODEPENDS=1 -C util wc
################################# c
justM2 all ::; $(MAKE) -C c all
clean ::; $(MAKE) NODEPENDS=1 -C c clean
wc ::;  $(MAKE) -C c NODEPENDS=1 wc
################################# c2
justM2 all ::; $(MAKE) NODEPENDS=1 -C c2 targettypes.h
clean ::; $(MAKE) NODEPENDS=1 -C c2 clean
################################# e
justM2 all ::; $(MAKE) -C e all
tests ::; $(MAKE) -C e tests
clean ::; $(MAKE) NODEPENDS=1 -C e clean
wc ::;  $(MAKE) -C e NODEPENDS=1 wc
################################# dbm
justM2 all ::; $(MAKE) -C dbm all
tests ::; $(MAKE) -C dbm tests
clean ::; $(MAKE) NODEPENDS=1 -C dbm clean
wc ::;  $(MAKE) -C dbm NODEPENDS=1 wc
################################# dumpdata
ifeq "$(DUMPDATA)" "yes"
justM2 all ::; $(MAKE) -C dumpdata all
tests ::; $(MAKE) -C dumpdata tests
endif
clean ::; $(MAKE) NODEPENDS=1 -C dumpdata clean
wc ::;  $(MAKE) -C dumpdata NODEPENDS=1 wc
################################# d
config ::; $(MAKE) NODEPENDS=1 -C d compat.h
justM2 all ::; util/restart d/restart.tmp $(MAKE) -C d all
clean ::; $(MAKE) NODEPENDS=1 -C d clean
wc ::;  $(MAKE) -C d NODEPENDS=1 wc
################################# basictests
all ::; $(MAKE) -C basictests -k
clean ::; $(MAKE) -C basictests clean
################################# thread
clean ::; if [ -d thread ]; then $(MAKE) -C thread clean; fi
################################# tutorial
#### keep this before 'm2' so the final/*.out files get made
justM2 all::; $(MAKE) -C tutorial all
clean::; $(MAKE) -C tutorial clean
################################# m2
all ::; $(MAKE) -C m2 all
justM2 ::; $(MAKE) -C m2 justM2
tests ::;  $(MAKE) -C m2 tests
clean ::; $(MAKE) -C m2 clean
wc ::;  $(MAKE) -C m2 wc
################################# test
tests ::; $(MAKE) -C test -k
clean ::; $(MAKE) -C test clean
################################# schubert
tests ::; if [ -d schubert ]; then $(MAKE) -C schubert tests; fi
################################# setup
all :: setup
	[ -x $< ] || chmod a+x $<
################################# experiments
clean ::; if [ -d experiments ]; then $(MAKE) -C experiments clean; fi
all   ::; if [ -d experiments ]; then $(MAKE) -C experiments all; fi
################################# slides
clean ::; if [ -d slides ]; then $(MAKE) -k -C slides clean; fi
tests ::; if [ -d slides ]; then $(MAKE) -k -C slides; fi
################################# html
doc :: html
html ::; $(MAKE) -C html all
clean ::; $(MAKE) -C html clean
################################# book
# doc :: book
book ::;  $(MAKE) -C book all
clean ::; $(MAKE) -C book clean
################################# ComputationsBook
doc :: ComputationsBook
ComputationsBook ::; if [ -d ComputationsBook ]; then $(MAKE) -C ComputationsBook all; fi
clean distclean  ::; if [ -d ComputationsBook ]; then $(MAKE) -C ComputationsBook $@; fi
################################# emacs
all ::;  $(MAKE) -C emacs all
clean ::; $(MAKE) -C emacs clean
################################# appendix to Vasconcelos' book
doc :: Vasconcelos-appendix
Vasconcelos-appendix ::; $(MAKE) -C Vasconcelos-appendix all
clean ::; $(MAKE) -C Vasconcelos-appendix clean
################################# socket
clean ::; if [ -d socket ]; then $(MAKE) -C socket clean; fi
################################# Mathematica
clean ::; if [ -d Mathematica ]; then $(MAKE) -C Mathematica clean; fi
################################# backup
backup ::; $(MAKE) -C m2 backup
backup ::; if [ -d docs ]; then $(MAKE) -C docs backup; fi
backup ::; if [ -d experiments ]; then $(MAKE) -C experiments backup; fi
