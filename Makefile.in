#############################################################################

# Targets to use:
#	all:	make a binary distribution
#	check:  run the tests
#	justM2:	make Macalay2/libexec/Macaulay2 and Macaulay2/bin/M2, and set up
#               for running it
#	doc:	make the documentation

#############################################################################
ifdef XYZZY
  If you get an error message on this line, it is because you are not using
  the 'gnu' version of the 'make' program.  The source code for it is
  available at ftp://ftp.gnu.org/pub/gnu/make.
endif
#############################################################################
include config.Makefile
top_srcdir = @top_srcdir@
VPATH = @srcdir@
INSTALL = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)
.PHONY : all always dirs clean announce MACAULAY2 MACAULAY2.doc doc port default lsm
default: all
all::
################################# preparation
justM2 all::; @echo 'making Macaulay 2 version $(VERSION) for ARCH=$(ARCH) OS=$(OS) REL=$(REL)'
always:
clean::; rm -rf lib
clean::; rm -f core
distclean::; rm -f config.cache config.log config.status configure.options
distclean:: clean
################################ SETUP
ifeq "$(CC)" "cl"
justM2 all:: ;	$(MAKE) -C WindowsNT
TARGET := Macaulay2-$(DESC).zip
DOCTARGET := Macaulay2-$(VERSION)-doc.zip
else
TARGET := Macaulay2-$(DESC).tar.gz
DOCTARGET := Macaulay2-$(VERSION)-doc.tar.gz
endif
###################### Macaulay 2 binary distribution
all :: MACAULAY2
all :: $(TARGET)
check : ; $(MAKE) -C Macaulay2 check
MACAULAY2:; $(MAKE) -C Macaulay2 all
justM2 distclean::; $(MAKE) -C Macaulay2 $@
DISTFILES_MADE:= \
		Macaulay2/setup \
		Macaulay2/cache/Macaulay2-doc \
		Macaulay2/libexec/Macaulay2@EXEEXT@ \
		Macaulay2/emacs \
		Macaulay2/m2/*.m2
DISTFILES_SRC := \
		$(shell cd @srcdir@; echo Macaulay2/m2/*.m2 Macaulay2/tutorial/final/*.m2) \
		Macaulay2/packages \
		Macaulay2/emacs \
		Macaulay2/CHANGES \
	 	Macaulay2/README.txt
DISTFILES := $(DISTFILES_SRC) $(DISTFILES_MADE)
install :
	@echo no install method yet >&2
	@exit 1
Macaulay2-$(DESC).tar.gz : Makefile $(DISTFILES)
	tar cf - $(DISTFILES_MADE) -C @srcdir@ $(DISTFILES_SRC) |gzip >"$@"
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains everything but the documentation"
	@echo "-----------------------------------------------------------------------------"
# Macaulay2-$(DESC).zip : Makefile $(DISTFILES)
# 	winzip32 -u -r -p $@ @WindowsNT/DistributionFiles.lst
# 	@echo "-----------------------------------------------------------------------------"
# 	@echo "  $@ contains everything but the documentation"
# 	@echo "-----------------------------------------------------------------------------"
clean ::; $(MAKE) -C Macaulay2 $@
###################### Macaulay 2 documentation
DOCFILES = Macaulay2/html
Macaulay2-$(VERSION)-doc.tar.gz : $(DOCFILES)
	tar cf - $(DOCFILES) | gzip >$@
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains the documentation"
	@echo "-----------------------------------------------------------------------------"
Macaulay2-$(VERSION)-doc.zip : $(DOCFILES)
	winzip32 -u -r -p $@ $(DOCFILES)
	@echo "-----------------------------------------------------------------------------"
	@echo "  $@ contains the documentation"
	@echo "-----------------------------------------------------------------------------"
MACAULAY2.doc:
	$(MAKE) -C Macaulay2 doc
doc:: MACAULAY2.doc 
doc:: $(DOCTARGET)
################################# final status messages
justM2 all doc::
	@echo "--------------------- done making '$@' --------------------"
################################# tar manufactured files
manufactured.tgz : Makefile
	make -C Macaulay2/d all-c-files
	make -C Macaulay2/tutorial
	tar cfz $@ \
		Macaulay2/e/geovec.hpp \
		Macaulay2/e/geores.hpp \
		Macaulay2/e/cmdnames.m2 \
		Macaulay2/e/cmdnames.hpp \
		Macaulay2/e/cmdinst.hpp \
		Macaulay2/m2/tutorials.m2 \
		Macaulay2/tutorial/final/*.out \
		Macaulay2/m2/gbdoc.m2 \
		Macaulay2/m2/gbfunctions.m2 \
		Macaulay2/m2/loads.m2 \
		Macaulay2/d/*.c \
		Macaulay2/m2/cache-tmp/Examples/*.m2 \
		Macaulay2/m2/cache-tmp/Tests/*.m2 \
		Macaulay2/html
################################# lsm
lsm:; sendmail lsm@execpc.com <Macaulay2.LSM
################################# configure
# make this one last
distclean ::; rm -f @CONFIGURED_FILES@ include/config.h config.Makefile

# Local Variables:
# mode: Makefile
# End:
