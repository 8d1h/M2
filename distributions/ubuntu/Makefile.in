# @configure_input@
include ../../include/config.Makefile
VPATH = @srcdir@
TIDY = yes
CHOWN = chown
prefixtail=$(shell echo @FINALPREFIX@ | sed 's=^/==')
include ../Makefile.filenames
PKG_DEB = @package@-@UBUNTUARCH@-@OS@.deb
PKG_COM_DEB = @package@-all.deb
TAROPTIONS = --owner=0 --group=0 --mode=a+rX,og-ws
.PHONY : prepare
############################## main targets
all install :: tidy_before
all install :: ../../$(PKG_DEB) ../../$(PKG_COM_DEB)
	@ echo "============================================================================="
	@ echo "ubuntu package files prepared: "
	@ echo "        $(PKG_DEB)"
	@ echo "        $(PKG_COM_DEB)"
	@ echo "============================================================================="
ifeq ($(TIDY),yes)
all install :: tidy_after
endif
#################################

ifneq (@DEBUG@,no)
$(error expected --disable-debug, in order to make a ubuntu package)
endif

ifneq (@OPTIMIZE@,yes)
$(error expected --enable-optimize, in order to make a ubuntu package)
endif

ifneq (@ENCAP@,yes)
$(error expected --enable-encap, in order to make a ubuntu package)
endif

../../$(PKG_DEB) : @srcdir@/macaulay2/debian-binary macaulay2/control.tar.gz macaulay2/data.tar.gz
	rm -f $@
	ar rc $@.tmp $^
	sed -e 's=\(debian-binary\|control.tar.gz\|data.tar.gz\)/\( *[0-9]* *\)[0-9 ]\{12\}=\1 \20     0     =g' < $@.tmp > $@
	rm $@.tmp
../../$(PKG_COM_DEB) : @srcdir@/macaulay2-common/debian-binary macaulay2-common/control.tar.gz macaulay2-common/data.tar.gz
	rm -f $@
	ar rc $@.tmp $^
	sed -e 's=\(debian-binary\|control.tar.gz\|data.tar.gz\)/\( *[0-9]* *\)[0-9 ]\{12\}=\1 \20     0     =g' < $@.tmp > $@
	rm $@.tmp

macaulay2/control.tar.gz : macaulay2/control macaulay2/postinst macaulay2/prerm
	cd macaulay2 && chmod 0644 control
	cd macaulay2 && chmod 0755 postinst prerm
	tar cfz $@ $(TAROPTIONS) -C macaulay2 control postinst prerm

macaulay2-common/control.tar.gz : macaulay2-common/control macaulay2-common/postinst macaulay2-common/prerm
	cd macaulay2-common && chmod 0644 control
	cd macaulay2-common && chmod 0755 postinst prerm
	tar cfz $@ $(TAROPTIONS) -C macaulay2-common control postinst prerm

.prepared : ; $(MAKE) prepare && touch $@
prepare : ../../$(PKG_TZ) ../../$(PKG_COM_TZ)
	rm -rf tmp@FINALPREFIX@ tmp-common@FINALPREFIX@
	@MKDIR_P@ tmp@FINALPREFIX@
	@MKDIR_P@ tmp-common@FINALPREFIX@
	tar xfp ../../$(PKG_TZ) @TAR_COMPRESS_OPTION@
	for i in @package@/* ; do if [ -f "$$i" ] ; then rm "$$i" ; fi ; done
	mv @package@/* tmp@FINALPREFIX@
	tar xfp ../../$(PKG_COM_TZ) @TAR_COMPRESS_OPTION@
	for i in @package@/* ; do if [ -f "$$i" ] ; then rm "$$i" ; fi ; done
	mv @package@/* tmp-common@FINALPREFIX@
	rmdir @package@
	@MKDIR_P@ tmp@FINALPREFIX@/share/doc/macaulay2
	@MKDIR_P@ tmp-common@FINALPREFIX@/share/doc/macaulay2-common
	cp tmp-common@FINALPREFIX@/@docpackagesdirtail@/README tmp@FINALPREFIX@/share/doc/macaulay2/copyright
	cp tmp-common@FINALPREFIX@/@docpackagesdirtail@/README tmp-common@FINALPREFIX@/share/doc/macaulay2-common/copyright
	gzip -9 <@srcdir@/macaulay2/changelog >tmp@FINALPREFIX@/share/doc/macaulay2/changelog.gz
	gzip -9 <@srcdir@/macaulay2-common/changelog >tmp-common@FINALPREFIX@/share/doc/macaulay2-common/changelog.gz
	find tmp tmp-common -name .linkdir | xargs rm -f
	find tmp-common -name \*.info | while read x ; do gzip --best "$$x" ; done
	find tmp tmp-common -name man -type d | while read x ; do find $$x -type f -not -name \*.gz | while read y ; do gzip --best "$$y" ; done ; done
	find tmp -name \*.so -o -name \*.so.\* -o -name \*.la | xargs chmod a-x Makefile
macaulay2/data.tar.gz        : prepare; (cd tmp        && tar cfz - $(TAROPTIONS) *) >$@
macaulay2-common/data.tar.gz : prepare;	(cd tmp-common && tar cfz - $(TAROPTIONS) *) >$@
macaulay2/md5sums            : prepare; (cd tmp        && find * -type f | xargs md5sum) >$@
macaulay2-common/md5sums     : prepare;	(cd tmp-common && find * -type f | xargs md5sum) >$@
ifneq (@LINTIAN@,)
check :
	- @LINTIAN@ -I ../../$(PKG_DEB)
	- @LINTIAN@ -I ../../$(PKG_COM_DEB)
endif
tidy_before :
	rm -rf @package@ tmp tmp-common
	rm -rf macaulay2/control.tar.gz macaulay2/data.tar.gz macaulay2/md5sums
	rm -rf macaulay2-common/control.tar.gz macaulay2-common/data.tar.gz macaulay2-common/md5sums
tidy tidy_after :
	rm -rf @package@ tmp tmp-common
	rm -rf macaulay2/control.tar.gz macaulay2/data.tar.gz macaulay2/md5sums
	rm -rf macaulay2-common/control.tar.gz macaulay2-common/data.tar.gz macaulay2-common/md5sums
clean :: tidy
	rm -rf @package@
	rm -rf ../../$(PKG_DEB)
	rm -rf ../../$(PKG_COM_DEB)
distclean : clean; rm -f Makefile control
always :
libraries-used : .prepared always
	ldd tmp@FINALPREFIX@/@bindirtail@/M2@EXE@ | sed -e 's/.* => //' -e 's/^	//' -e 's/ .*//' | egrep '^/' | egrep `echo "@LIBFILES@" | sed -e 's=\([^ ][^ ]*\)=/\1\\\\.=g' -e 's/  */|/g'` >$@
packages-used : libraries-used
	cat libraries-used | while read x ; do find /var/lib/dpkg/info -name \*.list | xargs egrep -l "^$$x"; done | sort | uniq | sed -e 's=.*/==' -e 's=\.list$$==' >$@
macaulay2/control : macaulay2/control.prelim macaulay2/data.tar.gz packages-used
	(cat $< && \
	 size=`gunzip<macaulay2/data.tar.gz|wc -c` && \
	 size=`echo $$size | sed 's/^\([0-9][0-9]*\).*/\1/'` && \
	 echo Installed-Size: $$size && \
	 cat packages-used | while read x ; do echo Depends: $$x ; done \
	) >$@
macaulay2-common/control : macaulay2-common/control.prelim macaulay2-common/data.tar.gz
	(cat $< && \
	 size=`gunzip<macaulay2-common/data.tar.gz|wc -c` && \
	 size=`echo $$size | sed 's/^\([0-9][0-9]*\).*/\1/'` && \
	 echo Installed-Size: $$size \
	) >$@
Makefile : Makefile.in; cd ../..; ./config.status distributions/ubuntu/Makefile
macaulay2/control.prelim : macaulay2/control.prelim.in; cd ../..; ./config.status distributions/ubuntu/macaulay2/control.prelim

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/distributions/ubuntu "
# End:
