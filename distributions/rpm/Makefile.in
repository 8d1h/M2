# @configure_input@
include ../../include/config.Makefile
VPATH = @srcdir@
DEPENDS = yes
include ../Makefile.filenames

# notice that fakeroot is required, get it here: http://ftp.debian.org/debian/pool/main/f/fakeroot

# commands for testing the rpm file:
#  install:
#    rpm -i -v --nodeps *.rpm
#  remove:
#	Version: 0.9.95
#	Release: 2
#    rpm -e -v --noscripts Macaulay2-0.9.95-2

PKG_RPM = @package@-@ARCH@-@OS@.rpm
PKG_COM_RPM = @package@-common.rpm
CHOWN = chown

############################## main targets
all install :: ../../$(PKG_RPM) ../../$(PKG_COM_RPM)
always :
warning: always
ifeq (@FAKEROOT@,)
	@echo "============================================================================="
	@echo "Warning: 'fakeroot' not installed (at configuration time), so"
	@echo "  either run this as root, or use 'make CHOWN=:' to bypass ownership setting."
	@echo "============================================================================="
endif
../../$(PKG_RPM) ../../$(PKG_COM_RPM) : Macaulay2-body.spec ../../$(PKG_TZ) ../../$(PKG_COM_TZ) Makefile warning
	rm -rf files files-common
	mkdir files files-common
	tar xzf ../../$(PKG_TZ)     @TAR_COMPRESS_OPTION@ -C files@FINALPREFIX@
	tar xzf ../../$(PKG_COM_TZ) @TAR_COMPRESS_OPTION@ -C files-common@FINALPREFIX@
	mv files@FINALPREFIX@/@package@/* files@FINALPREFIX@
	mv files-common@FINALPREFIX@/@package@/* files-common@FINALPREFIX@
	rmdir files@FINALPREFIX@/@package@
	rmdir files-common@FINALPREFIX@/@package@
	cd files@FINALPREFIX@ && rm -f INSTALL encapinfo postinstall preremove
	cd files-common@FINALPREFIX@ && rm -f INSTALL encapinfo postinstall preremove
	cat Macaulay2-body.spec >Macaulay2.spec
	cat Macaulay2-common-body.spec >Macaulay2-common.spec
	(cd files && find . -type f) | sed -e 's=^./="=' -e 's=$$="=' >>Macaulay2.spec
	(cd files-common && find . -type f) | sed -e 's=^./="=' -e 's=$$="=' >>Macaulay2-common.spec
	@FAKEROOT@ $(CHOWN) -R root files files-common
	@FAKEROOT@ rpmbuild -bb Macaulay2.spec
	@FAKEROOT@ rpmbuild -bb Macaulay2-common.spec
	rm -rf files files-common
try-alien : ../../@PKG_DEB@ ; @FAKEROOT@ alien --generate --scripts --to-rpm $^
clean ::; rm -f ../../$(PKG_RPM) ../../$(PKG_COM_RPM) Macaulay2.spec files files-common
distclean : clean; rm -f Makefile
Makefile : Makefile.in; cd ..; ./config.status distributions/rpm/Makefile
Macaulay2-body.spec : Macaulay2-body.spec.in; cd ..; ./config.status distributions/rpm/Macaulay2-body.spec

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/distributions/rpm "
# End:
