# @configure_input@

# see http://cygwin.com/setup.html for info on making cygwin packages

ifneq (@FINALPREFIX@,/usr)
$(error expected --with-final-prefix=/usr, to comply with cygwin package standards)
endif

ifneq (@STRIP@,yes)
$(error expected --enable-strip, to comply with cygwin package standards)
endif

ifneq (@DEBUG@,no)
$(error expected --disable-debug, in order to make a cygwin package)
endif

ifneq (@OPTIMIZE@,yes)
$(error expected --enable-optimize, in order to make a cygwin package)
endif

ifneq (@ENCAP@,yes)
$(error expected --enable-encap, in order to make a cygwin package)
endif

include ../../include/config.Makefile
include ../Makefile.filenames
VPATH = @srcdir@

finalprefix := @FINALPREFIX@
prefixtail  := $(shell basename $(finalprefix))
prefixdir   := $(shell dirname $(finalprefix))
ifeq ($(prefixdir),/)
prefixdir = /.
endif

all install :: \
		server/Macaulay2 \
		server/Macaulay2/@package@-@CYGWIN_RELEASE@.tar.bz2 \
		server/Macaulay2/@package@-@CYGWIN_RELEASE@-src.tar.bz2 \
		server/Macaulay2/setup.hint \
		server/setup.ini \
		tidy
	@ echo "============================================================================="
	@ echo "the cygwin package files have been prepared in cygwin/server"
	@ echo "============================================================================="
server/setup.ini : ; PATH=`cd @srcdir@; pwd`:$(PATH) $(MAKE) -C server setup.ini
server/Macaulay2 : ; @MKDIR_P@ $@

TIDY = yes
ifeq ($(TIDY),yes)
tidy :
	rm -rf files
else
tidy :
endif

.prepared : server/Macaulay2 postinstall.sh preremove.sh \
	    ../../$(PKG_TGZ) ../../$(PKG_COM_TGZ)
	set -x ; if [ -d files ] ; then mv files junk ; rm -rf junk & fi
	mkdir files
	@MKDIR_P@ files$(prefixdir)
	@FAKEROOT@ tar xzf ../../$(PKG_TGZ) -C files$(prefixdir)
	@FAKEROOT@ tar xzf ../../$(PKG_COM_TGZ) -C files$(prefixdir)
	mv files$(prefixdir)/@package@ files$(prefixdir)/$(prefixtail)
	cd files$(finalprefix) && rm -f INSTALL encapinfo postinstall preremove
	@MKDIR_P@ files/etc/postinstall files@FINALPREFIX@
	@INSTALL_PROGRAM@ postinstall.sh files/etc/postinstall/@PACKAGE_TARNAME@.sh
	@MKDIR_P@ files/etc/preremove files@FINALPREFIX@
	@INSTALL_PROGRAM@ preremove.sh files/etc/preremove/@PACKAGE_TARNAME@.sh
ifneq (@FAKEROOT@,)
	@FAKEROOT@ chown -R root.root files
endif

server/Macaulay2/@package@-@CYGWIN_RELEASE@.tar.bz2 : .prepared
	(cd files && @FAKEROOT@ tar cjf - *) >$@

libraries-used : .prepared
	cygcheck files@FINALPREFIX@/@bindirtail@/M2@EXE@ \
	| sed -e 's/^  *//' \
	| dd conv=lcase \
	| sed 's=\\=/=g' \
	| egrep "(/lib/|/bin/).*\.dll$$" \
	| sed -e 's=.*/lib/=/lib/=' -e 's=.*/bin/=/bin/=' \
	| sort | uniq \
	| tee $@

packages-used : libraries-used
	cat libraries-used \
	| while read x ; do cygcheck -f $$x ; done \
	| sort | uniq \
	| sed 's/\([a-zA-Z0-9]*\)-\([0-9.]*\)-.*/\1 \2/' \
	| tee $@

setup.hint : setup.hint-base packages-used
	( set -e ; \
	  cat setup.hint-base ; \
	  echo -n "requires:" ; \
	  cat packages-used |while read pkg rel ; do echo -n " $$pkg" ; done ; \
	  echo ) | tee $@

server/Macaulay2/setup.hint : setup.hint server/Macaulay2 ; cp $< $@

ifeq (@SRCTARFILE@,)
@package@-@CYGWIN_RELEASE@ : always
	rm -f $@
	ln -sf @srcdir@/../.. $@
src-files : always
	svn ls -R @srcdir@/../.. | egrep -v '/$$' | sed 's=^=@package@-@CYGWIN_RELEASE@/=' >$@
mkrt : src-files @package@-@CYGWIN_RELEASE@
ifneq (@FAKEROOT@,)
	cat src-files | @FAKEROOT@ xargs chown root.root
endif
server/Macaulay2/@package@-@CYGWIN_RELEASE@-src.tar.bz2 : server/Macaulay2 mkrt src-files
	@FAKEROOT@ tar cfj $@ --files-from=src-files
else
src-tree : @SRCTARFILE@
	rm -rf $@
	@MKDIR_P@ $@
	tar xzf $< -C $@
	rm -f @package@-@CYGWIN_RELEASE@
	ln -s srctree/* @package@-@CYGWIN_RELEASE@
mkrt : src-tree
ifneq (@FAKEROOT@,)
	@FAKEROOT@ chown -R root.root src-tree
endif
server/Macaulay2/@package@-@CYGWIN_RELEASE@-src.tar.bz2 : server/Macaulay2 mkrt
	@FAKEROOT@ tar cfj $@ @package@-@CYGWIN_RELEASE@/.
endif

install :: Macaulay2.README
	@INSTALL@ -d @encapdir@/share/doc/Cygwin
	@INSTALL@ Macaulay2.README @encapdir@/share/doc/Cygwin

clean ::; rm -rf server files src-files
distclean : clean; rm -f Makefile Macaulay2.README setup.hint
Makefile : Makefile.in; cd ../..; ./config.status distributions/cygwin/Makefile
setup.hint-base : setup.hint-base.in; cd ../..; ./config.status distributions/cygwin/setup.hint-base
Macaulay2.README : Macaulay2.README.in; cd ../..; ./config.status distributions/cygwin/Macaulay2.README

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/distributions/cygwin "
# End:
