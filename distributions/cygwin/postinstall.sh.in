#! /bin/sh

# this is the cygwin postinstall script, to be installed in /etc/postinstall/Macaulay2.sh

cd @FINALPREFIX@/share/info
for p in @PACKAGES@
do install-info $p.info dir
done

STARTFILE=@FINALPREFIX@/share/emacs/site-lisp/site-start.el
LINE="(load \"M2-init.el\" t)"
REGEX="^\(load \"M2-init\.el\" t\)$"
if ! [ -f "$STARTFILE" ] || ! egrep -q "$REGEX" "$STARTFILE"
then i=1
     if [ -f "$STARTFILE" ]
     then while true
	  do if ln "$STARTFILE" "$STARTFILE".bak.$i 2>/dev/null
	     then break
	     else i=`expr $i + 1`
	     fi
	     if [ $i -gt 100 ]
	     then echo failed to make backup file for "$STARTFILE" >&2
		  exit 1
	     fi
	  done
	  sed '/M2-init.el/d' <"$STARTFILE" >"$STARTFILE".tmp.$$
	  echo "$LINE" >>"$STARTFILE".tmp.$$
	  rm "$STARTFILE"
	  ln "$STARTFILE".tmp.$$ "$STARTFILE"
	  rm "$STARTFILE".tmp.$$
     else
	  echo "$LINE" >"$STARTFILE"
     fi
fi
