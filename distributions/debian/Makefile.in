# @configure_input@
include ../../include/config.Makefile
VPATH = @srcdir@
TIDY = yes
DEPENDS = yes
finalprefix=@FINALPREFIX@
prefixtail=$(shell echo $(finalprefix) | sed 's=^/==')
prefixdir=$(shell dirname $(finalprefix))
############################## main targets
all install :: ../../@PKG_DEB@
	@ echo "============================================================================="
	@ echo "debian package file prepared: "
	@ echo "        @PKG_DEB@"
	@ echo "============================================================================="
ifeq ($(TIDY),yes)
all install :: tidy
endif
#################################

ifneq (@DEBUG@,no)
$(error expected --disable-debug, in order to make a debian package)
endif

ifneq (@OPTIMIZE@,yes)
$(error expected --enable-optimize, in order to make a debian package)
endif

ifneq (@ENCAP@,yes)
$(error expected --enable-encap, in order to make a debian package)
endif

# notice that fakeroot is required, get it here: http://ftp.debian.org/debian/pool/main/f/@FAKEROOT@
../../@PKG_DEB@ : debian-binary control.tar.gz data.tar.gz
	rm -f $@
	@FAKEROOT@ chown root.root $^
	@FAKEROOT@ ar rc $@.tmp $^
	sed -e 's=debian-binary/=debian-binary =' -e 's=control.tar.gz/=control.tar.gz =' -e 's=data.tar.gz/=data.tar.gz =' < $@.tmp > $@
	rm $@.tmp
CONTROLFILES := md5sums control
CONTROLSCRIPTS := 
# CONTROLSCRIPTS += preinst
CONTROLSCRIPTS += postinst
CONTROLSCRIPTS += prerm
# CONTROLSCRIPTS += postrm
control.tar.gz : $(CONTROLFILES) $(CONTROLSCRIPTS)
	chmod 0644 $(CONTROLFILES)
	chmod 0755 $(CONTROLSCRIPTS)
	@FAKEROOT@ chown root $^
	@FAKEROOT@ tar cfz $@ $^

prepare : ../../@PKG_TZ@
	rm -rf @package@ tmp
	@MKDIR_P@ tmp@FINALPREFIX@
	tar xfp $^ @TAR_COMPRESS_OPTION@
	for i in @package@/* ; do if [ -f "$$i" ] ; then rm "$$i" ; fi ; done
	mv @package@/* tmp@FINALPREFIX@
	rmdir @package@
	@MKDIR_P@ tmp@FINALPREFIX@/share/doc/macaulay2
	cp tmp@FINALPREFIX@/@docpackagesdirtail@/README tmp@FINALPREFIX@/share/doc/macaulay2/copyright
	gzip -9 <@srcdir@/changelog >tmp@FINALPREFIX@/share/doc/macaulay2/changelog.gz
	find tmp -name .linkdir | xargs rm -f
	find tmp -name \*.info | while read x ; do gzip --best "$$x" ; done
	find tmp -name man -type d | while read x ; do find $$x -type f -not -name \*.gz | while read y ; do gzip --best "$$y" ; done ; done
	find tmp -name \*.so -o -name \*.so.\* -o -name \*.la | xargs chmod a-x Makefile
	chmod -R og-w,a+r tmp
	@FAKEROOT@ chown -R root tmp
data.tar.gz : prepare
	(cd tmp && @FAKEROOT@ tar cfz - *) >$@
md5sums : prepare
	(cd tmp && find * -type f | xargs md5sum) >$@
ifneq (@LINTIAN@,)
check :
	- @LINTIAN@ -Ivi ../../@PKG_DEB@
endif
tidy :
	rm -rf tmp control.tar.gz data.tar.gz md5sums
clean ::
	rm -rf @package@ tmp debian-binary control.tar.gz data.tar.gz md5sums
	rm -rf ../../@PKG_DEB@
distclean : clean; rm -f Makefile control

Makefile : Makefile.in; cd ../..; ./config.status distributions/debian/Makefile
control.prelim : control.prelim.in
	cd ../..; ./config.status distributions/debian/control.prelim
	chmod 0755 $@
control : control.prelim prepare
	(cat $< && size=`du -s tmp` && size=`echo $$size | sed 's/^\([0-9][0-9]*\).*/\1/'` && echo Installed-Size: $$size) >$@
prerm : prerm.in
	cd ../..; ./config.status distributions/debian/prerm
	chmod 0755 $@
preinst : preinst.in
	cd ../..; ./config.status distributions/debian/preinst
	chmod 0755 $@
postrm : postrm.in
	cd ../..; ./config.status distributions/debian/postrm
	chmod 0755 $@
postinst : postinst.in
	cd ../..; ./config.status distributions/debian/postinst
	chmod 0755 $@

# Local Variables:
# compile-command: "make -C $M2BUILDDIR/distributions/debian "
# End:
