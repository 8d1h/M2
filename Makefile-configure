# -*- Mode: Makefile -*-
default : stage2

CONFIGURE_OPTIONS = --prefix=/tmp/Macaulay2-$(shell cat version) --cache-file=config.cache
CONFIGURE_ENVIRON = CFLAGS="-O2" CXXFLAGS="-O2"

include Makefile-configure.overrides
Makefile-configure.overrides :
	echo "# -*- Mode: Makefile -*-" > $@
	echo "# CONFIGURE_OPTIONS += --disable-dumpdata" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-dumpdata=old" >>$@
	echo "# CONFIGURE_OPTIONS += --with-socks" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-shared" >>$@
	echo "# CONFIGURE_OPTIONS += --disable-strip" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-profile" >>$@
	echo "# CONFIGURE_OPTIONS += --disable-optimize" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-debug" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-static" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-memdebug" >>$@
	echo "# CONFIGURE_OPTIONS += --enable-verbose" >>$@
	echo "# CONFIGURE_OPTIONS += --without-factory" >>$@

## to build:
##	add overrides to the file Makefile-configure.overrides
##		example: CONFIGURE_OPTIONS += --disable-dumpdata
##	make -f Makefile-configure
##	make
##      make install
## or
##      ./configure --prefix=/usr/local ...
##      make 
##      make install

## to rebuild configure script without using this makefile:
##	autoconf
##	autoheader

#############################################################################
# this list is the same as the one in configure.in
export CONFIGURED_FILES := \
	config.Makefile \
	Makefile \
	Macaulay2/Makefile \
	Macaulay2/m2/Makefile \
	Macaulay2/Mathematica/Makefile \
	Macaulay2/Vasconcelos-appendix/Makefile \
	Macaulay2/basictests/Makefile \
	Macaulay2/benchmarks/Makefile \
	Macaulay2/benchmarks2/Makefile \
	Macaulay2/book/Makefile \
	Macaulay2/c/Makefile \
	Macaulay2/c2/Makefile \
	Macaulay2/d/Makefile \
	Macaulay2/dbm/Makefile \
	Macaulay2/dumpdata/Makefile \
	Macaulay2/e/Makefile \
	Macaulay2/emacs/Makefile \
	Macaulay2/experiments/Makefile \
	Macaulay2/gmp-macros/Makefile \
	Macaulay2/html/Makefile \
	Macaulay2/mike-slides/Makefile \
	Macaulay2/mike-tut/Makefile \
	Macaulay2/packages/Makefile \
	Macaulay2/schubert/Makefile \
	Macaulay2/screen/Makefile \
	Macaulay2/slides/Makefile \
	Macaulay2/socket/Makefile \
	Macaulay2/test/Makefile \
	Macaulay2/tex/Makefile \
	Macaulay2/texmacs/Makefile \
	Macaulay2/thread/Makefile \
	Macaulay2/tutorial/Makefile \
	Macaulay2/setup \
	Macaulay2/util/Makefile
#############################################################################

stage1 : configure include/config.h.in
configure : configure.in aclocal.m4
	autoconf
include/config.h.in : configure.in aclocal.m4
	autoheader
	touch $@

stage2 : Makefile include/config.h
config.status : configure Makefile-configure
	$(CONFIGURE_ENVIRON) ./configure $(CONFIGURE_OPTIONS) --no-create --cache-file=config.cache

$(CONFIGURED_FILES) include/config.h : $(CONFIGURED_FILES:=.in) config.status include/config.h.in
	./config.status
	touch include/config.h

TARGETS = all install dist check clean distclean uninstall

$(TARGETS) :: Makefile include/config.h
	make $@

